<!doctype html>
<html>
<head>

  <title>at-form-lookup tests</title>

  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
  <meta name="viewport" content="width=device-width, minimum-scale=1.0, initial-scale=1, user-scalable=yes">

  <script src="../../webcomponentsjs/webcomponents-lite.js"></script>

  <script src="../../web-component-tester/browser.js"></script>
  <script src="../../iron-test-helpers/test-helpers.js"></script>
  <script src="../../iron-test-helpers/mock-interactions.js"></script>

  <link rel="import" href="lookup-test-helper.html">
</head>
<body>

  <test-fixture id="initialLocal">
    <template>
      <lookup-test-helper></lookup-test-helper>
    </template>
  </test-fixture>

  <test-fixture id="valueAsAttrLocal">
    <template>
      <lookup-test-helper value="v1"></lookup-test-helper>
    </template>
  </test-fixture>

  <test-fixture id="initialRemote">
    <template>
      <lookup-test-helper url="localhost:2014"></lookup-test-helper>
    </template>
  </test-fixture>

  <test-fixture id="valueAsAttrRemote">
    <template>
      <lookup-test-helper url="localhost:2014" value="v1"></lookup-test-helper>
    </template>
  </test-fixture>

  <script>
    //
    //
    //
    // TODO: add fixture with xvalue list
    // selected-items-changed can be fired when xvaluelist is not empty
    // otherwise its not fired
    //
    //
    //
    suite('initial local data', function() {

      var valueEventCount;
      var selectedItemsEventCount;

      var expectedValue;
      var expectedSelectedItems;

      setup(function() {
        valueEventCount = 0;
        selectedItemsEventCount = 0;

        expectedValue = '';
        expectedSelectedItems = [];

        stub('lookup-test-helper', {

          _handleValueChangedEvent: function(event, detail) {
            assert.deepEqual(detail.value, expectedValue);
            assert.deepEqual(event.target.value, expectedValue);

            valueEventCount += 1;
          },

          _handleSelectedItemsChangedEvent: function(event, detail) {
            assert.deepEqual(detail.value, expectedValue);
            assert.deepEqual(event.target.value, expectedValue);

            assert.deepEqual(detail.value, expectedSelectedItems);
            assert.deepEqual(event.target.selectedItems, expectedSelectedItems);

            selectedItemsEventCount += 1;
          }
        });
      });

      test('initial', function() {
        var elt = fixture('initialLocal');

        assert.equal(elt.value, expectedValue);
        assert.deepEqual(elt.selectedItems, expectedSelectedItems);

        assert.equal(valueEventCount, 0);
        assert.equal(selectedItemsEventCount, 0);
      });

      test('count events when value changes as attribute', function() {
        var elt = fixture('initialLocal');

        actualValue = "v1";
        expectedValue = "v1";
        expectedSelectedItems = [];
        for (var i = 0; i < 3; i++) {
          elt.setAttribute('value', actualValue);
          assert.equal(valueEventCount, 1);
          assert.equal(elt.value, expectedValue);

          assert.equal(selectedItemsEventCount, 0);
          assert.deepEqual(elt.selectedItems, expectedSelectedItems);
        }

        actualValue = "v2";
        expectedValue = "v2";
        expectedSelectedItems = [];
        for (var i = 0; i < 3; i++) {
          elt.setAttribute('value', actualValue);
          assert.equal(valueEventCount, 2);
          assert.equal(elt.value, expectedValue);

          assert.equal(selectedItemsEventCount, 0);
          assert.deepEqual(elt.selectedItems, expectedSelectedItems);
        }

        actualValue = "v3";
        expectedValue = "v3";
        expectedSelectedItems = [];
        for (var i = 0; i < 3; i++) {
          elt.setAttribute('value', actualValue);
          assert.equal(valueEventCount, 3);
          assert.equal(elt.value, expectedValue);

          assert.equal(selectedItemsEventCount, 0);
          assert.deepEqual(elt.selectedItems, expectedSelectedItems);
        }

      });

      test('count events when value changes as property', function() {
        var elt = fixture('initialLocal');

        actualValue = "v1";
        expectedValue = "v1";
        expectedSelectedItems = [];
        for (var i = 0; i < 3; i++) {
          elt.value = actualValue;
          assert.equal(valueEventCount, 1);
          assert.equal(elt.value, expectedValue);

          assert.equal(selectedItemsEventCount, 0);
          assert.deepEqual(elt.selectedItems, expectedSelectedItems);
        }

        actualValue = {};
        expectedValue = {};
        expectedSelectedItems = [];
        for (var i = 0; i < 3; i++) {
          elt.value = actualValue;
          assert.equal(valueEventCount, 2);
          assert.deepEqual(elt.value, expectedValue);

          assert.equal(selectedItemsEventCount, 0);
          assert.deepEqual(elt.selectedItems, expectedSelectedItems);
        }

        actualValue = "v2";
        expectedValue = "v2";
        expectedSelectedItems = [];
        for (var i = 0; i < 3; i++) {
          elt.value = actualValue;
          assert.equal(valueEventCount, 3);
          assert.equal(elt.value, expectedValue);

          assert.equal(selectedItemsEventCount, 0);
          assert.deepEqual(elt.selectedItems, expectedSelectedItems);
        }

        actualValue = [];
        expectedValue = [];
        expectedSelectedItems = [];
        for (var i = 0; i < 3; i++) {
          elt.value = actualValue;
          assert.equal(valueEventCount, 4);
          assert.deepEqual(elt.value, expectedValue);

          assert.equal(selectedItemsEventCount, 0);
          assert.deepEqual(elt.selectedItems, expectedSelectedItems);
        }

        actualValue = "v3";
        expectedValue = "v3";
        expectedSelectedItems = [];
        for (var i = 0; i < 3; i++) {
          elt.value = actualValue;
          assert.equal(valueEventCount, 5);
          assert.equal(elt.value, expectedValue);

          assert.equal(selectedItemsEventCount, 0);
          assert.deepEqual(elt.selectedItems, expectedSelectedItems);
        }

        actualValue = null;
        expectedValue = null;
        expectedSelectedItems = [];
        for (var i = 0; i < 3; i++) {
          elt.value = actualValue;
          assert.equal(valueEventCount, 6);
          assert.equal(elt.value, expectedValue);

          assert.equal(selectedItemsEventCount, 0);
          assert.deepEqual(elt.selectedItems, expectedSelectedItems);
        }

        actualValue = "v4";
        expectedValue = "v4";
        expectedSelectedItems = [];
        for (var i = 0; i < 3; i++) {
          elt.value = actualValue;
          assert.equal(valueEventCount, 7);
          assert.equal(elt.value, expectedValue);

          assert.equal(selectedItemsEventCount, 0);
          assert.deepEqual(elt.selectedItems, expectedSelectedItems);
        }
      });

    });

    //
    // local data value set as attr
    //

    suite('value as attr local data', function() {

      var valueEventCount;
      var selectedItemsEventCount;

      var expectedValue;
      var expectedSelectedItems;

      setup(function() {
        valueEventCount = 0;
        selectedItemsEventCount = 0;

        expectedValue = 'v1';
        expectedSelectedItems = [];

        stub('lookup-test-helper', {

          _handleValueChangedEvent: function(event, detail) {
            assert.deepEqual(detail.value, expectedValue);
            assert.deepEqual(event.target.value, expectedValue);

            valueEventCount += 1;
          },

          _handleSelectedItemsChangedEvent: function(event, detail) {
            assert.deepEqual(detail.value, expectedValue);
            assert.deepEqual(event.target.value, expectedValue);

            assert.deepEqual(detail.value, expectedSelectedItems);
            assert.deepEqual(event.target.selectedItems, expectedSelectedItems);

            selectedItemsEventCount += 1;
          }
        });
      });

      test('value as attr', function() {
        var elt = fixture('valueAsAttrLocal');

        assert.equal(elt.value, expectedValue);
        assert.deepEqual(elt.selectedItems, expectedSelectedItems);

        assert.equal(valueEventCount, 0);
        assert.equal(selectedItemsEventCount, 0);
      });

    });

















  </script>

</body>
</html>
